@inject GameLogic gameInfo
@implements IDisposable

@{
    var stateClass = gameInfo.CurrentGameState switch
    {
        GameState.Joining => "state-joining",
        GameState.Eating => "state-eating",
        GameState.Battle => "state-battle",
        GameState.GameOver => "state-gameover",
        _ => "state-joining"
    };
}

<div class="d-flex align-items-center gap-3 flex-wrap">
    <div class="game-state-badge @stateClass">
        <span class="state-dot"></span>
        @gameInfo.CurrentGameState
    </div>

    @if (gameInfo.GameEndsOn.HasValue)
    {
        <span class="game-timer">
            Resets @gameInfo.GameEndsOn.Value.ToString("h:mm tt") &mdash; @timeRemaining left
        </span>
    }
</div>

@code {
    [CascadingParameter]
    public SharedStateClass SharedState { get; set; }
    private System.Timers.Timer timer;
    private string timeRemaining;

    protected override void OnInitialized()
    {
        gameInfo.GameStateChanged += (_, _) => InvokeAsync(() => StateHasChanged());
        timer = new System.Timers.Timer(1_000);
        timer.Elapsed += (_, _) =>
        {
            var formatString = @"mm\:ss";
            if (gameInfo.TimeRemaining < TimeSpan.FromSeconds(10))
            {
                timer.Interval = 250;
                formatString = @"s\.fff";
            }
            InvokeAsync(() =>
            {
                timeRemaining = gameInfo?.TimeRemaining?.ToString(formatString) ?? "";
                StateHasChanged();
            });
        };
        timer.Start();
    }

    public void Dispose()
    {
        timer.Dispose();
    }
}
