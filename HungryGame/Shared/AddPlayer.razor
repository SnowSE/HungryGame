@inject GameLogic gameInfo
@inject ILogger<AddPlayer> log
@using System.ComponentModel.DataAnnotations;
@using Microsoft.AspNetCore.Mvc

<div class="vh-90 w-100" @onkeydown=keyPress tabindex="0" @ref="myDiv">
    @if (joined)
    {
        <div class="game-card" style="max-width: 400px; margin: 40px auto; text-align: center;">
            <p style="color: var(--text-secondary); margin-bottom: 24px;">Use arrow buttons or keyboard arrows to move</p>
            <div class="dpad-container">
                <button class="dpad-btn dpad-up" @onclick="moveUp">&#x25B2;</button>
                <button class="dpad-btn dpad-left" @onclick="moveLeft">&#x25C0;</button>
                <button class="dpad-btn dpad-right" @onclick="moveRight">&#x25B6;</button>
                <button class="dpad-btn dpad-down" @onclick="moveDown">&#x25BC;</button>
            </div>
        </div>
    }
    else if (gameAlreadyStarted)
    {
        <div class="error-message" style="max-width: 400px; margin: 40px auto; text-align: center;">
            Too late &mdash; game already started.
        </div>
    }
    else
    {
        <div class="game-card" style="max-width: 400px; margin: 40px auto;">
            <h3 style="color: var(--neon-green); margin-bottom: 16px;">Join Game</h3>
            <EditForm Model="@joinPlayerInfo" OnValidSubmit="@HandleValidSubmit" class="join-form">
                <InputText DisplayName="Player Name" @bind-Value="joinPlayerInfo.PlayerName" placeholder="Enter your name..." class="form-control" />
                <button type="submit" class="btn btn-primary">Join</button>
            </EditForm>
        </div>
    }
</div>


@code
{
    private class JoinPlayerInfo
    {
        [Required]
        public string? PlayerName { get; set; }
    }
    private JoinPlayerInfo joinPlayerInfo = new();
    private bool joined = false;
    private bool gameAlreadyStarted = false;
    private string token = null;
    private ElementReference myDiv;

    private async Task HandleValidSubmit()
    {
        try
        {
            token = gameInfo.JoinPlayer(joinPlayerInfo?.PlayerName);
            joined = true;
            joinPlayerInfo.PlayerName = null;
            await myDiv.FocusAsync();
        }
        catch (GameAlreadyStartedException)
        {
            gameAlreadyStarted = true;
        }
    }

    private void keyPress(KeyboardEventArgs args)
    {
        var direction = args.Key switch
        {
            "ArrowUp" => Direction.Up,
            "ArrowLeft" => Direction.Left,
            "ArrowRight" => Direction.Right,
            "ArrowDown" => Direction.Down,
            _ => Direction.Undefined
        };
        if (direction != Direction.Undefined)
        {
            gameInfo.Move(token, direction);
        }
    }

    private void moveUp() => gameInfo.Move(token, Direction.Up);
    private void moveRight() => gameInfo.Move(token, Direction.Right);
    private void moveLeft() => gameInfo.Move(token, Direction.Left);
    private void moveDown() => gameInfo.Move(token, Direction.Down);
}
