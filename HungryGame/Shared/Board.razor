@inject GameLogic gameInfo
@inject IJSRuntime JS

<style>
    .board-container {
        position: relative;
        background: #1a1a1a;
        padding: 1rem;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .board-canvas-wrap {
        width: 100%;
        aspect-ratio: @gameInfo.MaxCols / @(Math.Max(gameInfo.MaxRows, 1));
        position: relative;
        border-radius: var(--radius-md);
        padding: 8px;
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        box-shadow: var(--shadow-card);
        overflow: hidden;
    }

    .board-canvas-wrap::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, var(--neon-green), var(--neon-cyan), var(--neon-pink));
    }

    .board-canvas-wrap.battle-mode {
        border-color: rgba(255, 68, 68, 0.3);
        box-shadow: 0 0 40px rgba(255, 68, 68, 0.1), var(--shadow-card);
    }

    .board-canvas-wrap.battle-mode::before {
        background: linear-gradient(90deg, var(--battle-red), var(--neon-orange), var(--battle-red));
        animation: battle-glow 1.5s ease-in-out infinite;
    }

    .fullscreen-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 1100;
        opacity: 0.8;
        transition: all 0.2s ease;
        background: rgba(0, 255, 136, 0.2);
        border: 2px solid rgba(0, 255, 136, 0.5);
        color: #00ff88;
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
    }

    .fullscreen-btn:hover {
        opacity: 1;
        background: rgba(0, 255, 136, 0.4);
        box-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
        transform: scale(1.1);
    }

    .fullscreen-btn svg {
        width: 20px;
        height: 20px;
        fill: currentColor;
    }

    :fullscreen .board-container {
        width: 100vw;
        height: 100vh;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0;
        background: black;
        overflow: visible;
    }

    :fullscreen .board-canvas-wrap {
        width: min(98vw, calc(98vh * @gameInfo.MaxCols / @(Math.Max(gameInfo.MaxRows, 1))));
        height: min(98vh, calc(98vw * @gameInfo.MaxRows / @(Math.Max(gameInfo.MaxCols, 1))));
        max-width: none;
        max-height: none;
        aspect-ratio: auto;
    }

    .fullscreen-leaderboard {
        display: none;
    }

    :fullscreen .fullscreen-leaderboard {
        display: block;
        position: absolute;
        top: 20px;
        left: 20px;
        width: 320px;
        max-height: 85vh;
        z-index: 1000;
        pointer-events: auto;
        font-size: 0.9rem;
        box-shadow: 0 8px 32px rgba(0,0,0,0.8);
        overflow: visible;
    }

    :fullscreen .fullscreen-leaderboard .leaderboard {
        background: rgba(10, 10, 26, 0.6) !important;
        backdrop-filter: blur(12px);
        border: 1px solid rgba(0, 255, 136, 0.3);
        border-radius: 12px;
        overflow: hidden;
    }

    :fullscreen .fullscreen-leaderboard .leaderboard-header {
        background: rgba(0, 255, 136, 0.15) !important;
        padding: 12px 18px;
    }

    :fullscreen .fullscreen-leaderboard .leaderboard-scroll {
        max-height: 60vh;
        background: transparent !important;
    }

    :fullscreen .fullscreen-leaderboard td {
        background: transparent !important;
    }
</style>

<div id="game-board-root" class="board-container">
    <button class="fullscreen-btn" @onclick="ToggleFullScreen" title="Toggle Fullscreen">
        <svg viewBox="0 0 24 24">
            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
        </svg>
    </button>

    <div class="fullscreen-leaderboard">
        <PlayerList />
    </div>

    <div class="board-canvas-wrap @(gameInfo.CurrentGameState == GameState.Battle ? "battle-mode" : "")">
        <canvas id="serverBoardCanvas" style="width:100%;height:100%;display:block;"></canvas>
    </div>
</div>

@code {

    [CascadingParameter]
    public SharedStateClass SharedState { get; set; }

    private bool jsReady;

    protected override void OnInitialized()
    {
        gameInfo.GameStateChanged += OnGameStateChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("boardRenderer.init", "serverBoardCanvas");
            jsReady = true;
            await PushBoardToCanvas();
        }
    }

    private async void OnGameStateChanged(object? sender, EventArgs e)
    {
        await InvokeAsync(async () =>
        {
            if (jsReady)
            {
                await PushBoardToCanvas();
            }
            StateHasChanged();
        });
    }

    private async Task PushBoardToCanvas()
    {
        var boardCells = gameInfo.GetBoardState().ToList();
        if (boardCells.Count == 0) return;

        int rows = gameInfo.MaxRows;
        int cols = gameInfo.MaxCols;
        var gridData = new byte[rows * cols];
        var playerPositions = new List<int[]>();

        foreach (var cell in boardCells)
        {
            int idx = cell.Location.Row * cols + cell.Location.Column;
            if (idx < 0 || idx >= gridData.Length) continue;

            if (cell.OccupiedBy != null)
            {
                gridData[idx] = (byte)(2 + ((cell.OccupiedBy.Id - 1) % 254));
                playerPositions.Add(new[] { cell.Location.Row, cell.Location.Column, cell.OccupiedBy.Id });
            }
            else if (cell.IsPillAvailable)
            {
                gridData[idx] = 1;
            }
        }

        await JS.InvokeVoidAsync("boardRenderer.render", rows, cols, gridData, playerPositions);
    }

    private async Task ToggleFullScreen()
    {
        await JS.InvokeVoidAsync("eval", @"
            var elem = document.getElementById('game-board-root');
            if (!document.fullscreenElement) {
                elem.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable full-screen mode: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        ");
    }
}
