@inject GameLogic gameInfo
@inject IConfiguration config

<EditForm Model="@NewGame" OnValidSubmit="@HandleValidSubmit" class="start-game-form">
    <h3 style="margin-bottom: 20px; color: var(--neon-green);">New Game</h3>
    <div class="form-group">
        <label>
            Rows
            <InputNumber DisplayName="Rows" @bind-Value="NewGame.NumRows" style="width: 80px" class="form-control" />
        </label>
        <label>
            Columns
            <InputNumber DisplayName="Columns" @bind-Value="NewGame.NumColumns" style="width: 80px" class="form-control" />
        </label>
        <label>
            Cell Icon
            <InputText DisplayName="Cell Icon" @bind-Value="NewGame.CellIcon" size="2" maxlength="2" class="form-control" />
        </label>
        @if (!SharedState.IsAdmin)
        {
            <label>
                Password
                <InputText type="password" DisplayName="Password" @bind-Value="NewGame.SecretCode" size="8" class="form-control" />
            </label>
        }
    </div>
    <div class="form-group mt-3 mb-3" style="align-items: center;">
        <div class="form-check">
            <InputCheckbox id="isTimed" DisplayName="Is Timed" @bind-Value="NewGame.IsTimed" class="form-check-input" />
            <label class="form-label" for="isTimed" style="text-transform: none; font-size: 0.9rem;">Timed Game</label>
        </div>
        @if (NewGame.IsTimed)
        {
            <label>
                Minutes
                <input type="number" class="form-control" min=1 max=10 size="3" style="width: 80px" @bind="NewGame.TimeLimitInMinutes" />
            </label>
        }
    </div>
    <div class="form-group">
        <button class="btn btn-primary" type="submit">Launch Game</button>

        @if (startGameError != null)
        {
            <div class="error-message mt-3">
                <strong>Access Denied</strong> &mdash; Invalid password
            </div>
        }
    </div>
</EditForm>

@code
{
    private NewGameInfo NewGame = new();
    private string startGameError;

    [CascadingParameter]
    public SharedStateClass SharedState { get; set; }

    protected override void OnInitialized()
    {
        if (gameInfo.LastGameInfo is { } last)
        {
            NewGame.NumRows = last.NumRows;
            NewGame.NumColumns = last.NumColumns;
            NewGame.CellIcon = last.CellIcon;
            NewGame.IsTimed = last.IsTimed;
            NewGame.TimeLimitInMinutes = last.TimeLimitInMinutes;
        }
        else
        {
            NewGame.NumRows = config.GetValue<int>("BOARD_HEIGHT", 20);
            NewGame.NumColumns = config.GetValue<int>("BOARD_WIDTH", 30);
        }
    }

    private async Task HandleValidSubmit()
    {
        if (SharedState.IsAdmin)
        {
            NewGame.SecretCode = SharedState.AdminPassword;
        }
        else if (NewGame.SecretCode != config["SECRET_CODE"])
        {
            startGameError = "Invalid password.  Unable to start game.";
            return;
        }
        startGameError = null;
        SharedState.CellIcon = NewGame.CellIcon;
        gameInfo.StartGame(NewGame);
        SharedState.GameEndsOn = NewGame.TimeLimitInMinutes.HasValue ? DateTime.Now.AddMinutes(NewGame.TimeLimitInMinutes.Value) : null;
    }
}
